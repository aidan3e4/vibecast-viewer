<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTP Upload Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
        }

        .panel {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-inline {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .form-inline .form-group {
            flex: 1;
        }

        .button {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            margin-right: 10px;
        }

        .button:hover:not(:disabled) {
            background: #45a049;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .button.secondary {
            background: #2196F3;
        }

        .button.secondary:hover:not(:disabled) {
            background: #0b7dda;
        }

        .loading {
            display: none;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-card:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }

        .image-card.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .image-card input[type="checkbox"] {
            margin-right: 10px;
        }

        .image-card .image-info {
            font-size: 0.9em;
            color: #666;
        }

        .image-card .image-preview {
            margin-top: 10px;
            width: 100%;
            border-radius: 4px;
        }

        .direction-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .direction-selector label {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .direction-selector input[type="checkbox"] {
            margin-right: 5px;
        }

        .direction-selector label:has(input:checked) {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .analysis-result {
            margin-top: 20px;
        }

        .result-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .result-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .result-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            align-items: start;
        }

        .result-image {
            width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-content {
            background: white;
            padding: 12px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 500px;
            overflow-y: auto;
        }

        @media (max-width: 900px) {
            .result-container {
                grid-template-columns: 1fr;
            }
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 50%;
            height: 2px;
            background: #e0e0e0;
            z-index: -1;
        }

        .step:first-child::before {
            display: none;
        }

        .step.active {
            color: #4CAF50;
            font-weight: bold;
        }

        .step.completed {
            color: #2e7d32;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f5f5f5;
            padding: 12px 20px;
            border-radius: 4px;
            flex: 1;
            text-align: center;
        }

        .stat-item .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-item .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .unwarped-group {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
        }

        .unwarped-group h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .unwarped-views {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .unwarped-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .unwarped-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .unwarped-card.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .unwarped-card input[type="checkbox"] {
            margin-right: 8px;
        }

        .unwarped-card .direction-label {
            font-weight: 600;
            color: #555;
            display: block;
            margin-bottom: 8px;
        }

        .unwarped-card img {
            width: 100%;
            border-radius: 4px;
            display: block;
        }

        /* Fullscreen image viewer */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            cursor: zoom-out;
            animation: fadeIn 0.2s ease-in;
        }

        .fullscreen-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-content {
            max-width: 95%;
            max-height: 95%;
            position: relative;
            cursor: default;
        }

        .fullscreen-image {
            max-width: 100%;
            max-height: 95vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
            z-index: 10001;
        }

        .fullscreen-close:hover {
            background: white;
            transform: scale(1.1);
        }

        .fullscreen-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10001;
            max-width: 90%;
            text-align: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Make images clickable */
        .image-preview, .unwarped-card img, .result-image {
            cursor: zoom-in;
            transition: transform 0.2s;
        }

        .image-preview:hover, .unwarped-card img:hover, .result-image:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FTP Upload Analyzer</h1>
            <p style="margin-top: 10px; color: #666;">Analyze fisheye images from FTP uploads with AI</p>
        </div>

        <div class="step-indicator">
            <div class="step active" id="step1">1. Select Time Range</div>
            <div class="step" id="step2">2. Select Images (Max 5)</div>
            <div class="step" id="step3">3. Unwarp Images</div>
            <div class="step" id="step4">4. Analyze with LLM</div>
        </div>

        <!-- Step 1: Time Range Selection -->
        <div class="panel">
            <h2>Step 1: Select Time Range</h2>
            <div class="form-inline">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" value="{{ default_start_date }}">
                </div>
                <div class="form-group">
                    <label for="startTime">Start Time</label>
                    <input type="time" id="startTime" value="00:00">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" value="{{ default_end_date }}">
                </div>
                <div class="form-group">
                    <label for="endTime">End Time</label>
                    <input type="time" id="endTime" value="23:59">
                </div>
                <button class="button" onclick="loadImages()">Load Images</button>
            </div>
            <p class="loading" id="loadLoading">Loading images...</p>
            <div class="error" id="loadError"></div>

            <div class="stats" id="imageStats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="totalImages">0</div>
                    <div class="stat-label">Total Images</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="selectedImages">0</div>
                    <div class="stat-label">Selected (Max 5)</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Image Selection -->
        <div class="panel" id="imageSelectionPanel" style="display: none;">
            <h2>Step 2: Select Images to Analyze (Maximum 5)</h2>
            <div class="images-grid" id="imagesGrid"></div>
            <button class="button" onclick="unwarpSelected()" style="margin-top: 20px;" id="unwarpBtn" disabled>Unwarp Selected Images</button>
            <p class="loading" id="unwarpLoading">Unwarping images...</p>
            <div class="error" id="unwarpError"></div>
            <div class="success" id="unwarpSuccess"></div>
        </div>

        <!-- Step 3: View Unwarped Images -->
        <div class="panel" id="unwarpedPanel" style="display: none;">
            <h2>Step 3: Select Unwarped Images to Analyze</h2>
            <p style="color: #666; margin-bottom: 15px;">Select which unwarped views you want to analyze with the LLM</p>
            <div id="unwarpedImagesGrid"></div>
        </div>

        <!-- Step 4: Analysis -->
        <div class="panel" id="analysisPanel" style="display: none;">
            <h2>Step 4: Configure and Run Analysis</h2>

            <div class="form-group">
                <label for="llmPrompt">Analysis Prompt</label>
                <textarea id="llmPrompt" rows="4" placeholder="What do you want to analyze?">Describe what you see in this room. Focus on people, activities, and notable objects or events.</textarea>
            </div>

            <div class="form-group">
                <label for="apiKey">OpenAI API Key</label>
                <input type="password" id="apiKey" placeholder="sk-..." value="{{ openai_api_key }}">
            </div>

            <div class="stats" style="margin-bottom: 15px;">
                <div class="stat-item">
                    <div class="stat-value" id="selectedUnwarpedCount">0</div>
                    <div class="stat-label">Images Selected for Analysis</div>
                </div>
            </div>

            <button class="button secondary" onclick="analyzeImages()" id="analyzeBtn" disabled>Analyze with LLM</button>
            <p class="loading" id="analyzeLoading">Analyzing images with LLM...</p>
            <div class="error" id="analyzeError"></div>

            <div class="analysis-result" id="analysisResults"></div>
        </div>
    </div>

    <!-- Fullscreen Image Viewer -->
    <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen(event)">
        <button class="fullscreen-close" onclick="closeFullscreen(event)" title="Close (Esc)">Ã—</button>
        <div class="fullscreen-content" onclick="event.stopPropagation()">
            <img id="fullscreenImage" class="fullscreen-image" src="" alt="">
        </div>
        <div class="fullscreen-info" id="fullscreenInfo"></div>
    </div>

    <script>
        let availableImages = [];
        let selectedImagePaths = [];
        let unwarpedData = {};
        let selectedUnwarpedImages = []; // Array of {timestamp, direction, path}
        let currentStep = 1;

        const DIRECTION_NAMES = {
            'N': 'North',
            'S': 'South',
            'E': 'East',
            'W': 'West',
            'B': 'Below'
        };

        function updateStep(step) {
            currentStep = step;
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        async function loadImages() {
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            const loading = document.getElementById('loadLoading');
            const errorDiv = document.getElementById('loadError');

            loading.classList.add('show');
            errorDiv.classList.remove('show');

            try {
                const response = await fetch('/api/images/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: startDate,
                        start_time: startTime,
                        end_date: endDate,
                        end_time: endTime
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    availableImages = data.images;
                    displayImages();
                    updateStep(2);
                } else {
                    errorDiv.textContent = 'Failed to load images: ' + (data.detail || 'Unknown error');
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.classList.add('show');
            } finally {
                loading.classList.remove('show');
            }
        }

        function displayImages() {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '';

            if (availableImages.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No images found in the selected time range.</p>';
                document.getElementById('imageSelectionPanel').style.display = 'block';
                document.getElementById('imageStats').style.display = 'none';
                return;
            }

            availableImages.forEach(img => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <label style="cursor: pointer; display: block;">
                        <input type="checkbox" value="${img.filepath}" onchange="toggleImageSelection(this)">
                        <strong>${img.filename}</strong>
                        <div class="image-info">
                            ${img.date} ${img.time}
                        </div>
                        <img src="/api/image/ftp_uploads/${img.filepath}" class="image-preview" loading="lazy">
                    </label>
                `;
                grid.appendChild(card);
            });

            document.getElementById('imageSelectionPanel').style.display = 'block';
            document.getElementById('imageStats').style.display = 'flex';
            document.getElementById('totalImages').textContent = availableImages.length;
            document.getElementById('selectedImages').textContent = '0';

            // Make images clickable for fullscreen
            setTimeout(attachImageClickHandlers, 100);
        }

        function toggleImageSelection(checkbox) {
            const card = checkbox.closest('.image-card');

            if (checkbox.checked) {
                if (selectedImagePaths.length >= 5) {
                    checkbox.checked = false;
                    alert('Maximum 5 images allowed');
                    return;
                }
                selectedImagePaths.push(checkbox.value);
                card.classList.add('selected');
            } else {
                selectedImagePaths = selectedImagePaths.filter(p => p !== checkbox.value);
                card.classList.remove('selected');
            }

            document.getElementById('selectedImages').textContent = selectedImagePaths.length;
            document.getElementById('unwarpBtn').disabled = selectedImagePaths.length === 0;
        }

        async function unwarpSelected() {
            if (selectedImagePaths.length === 0) {
                alert('Please select at least one image');
                return;
            }

            const loading = document.getElementById('unwarpLoading');
            const errorDiv = document.getElementById('unwarpError');
            const successDiv = document.getElementById('unwarpSuccess');
            const unwarpBtn = document.getElementById('unwarpBtn');

            loading.classList.add('show');
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');
            unwarpBtn.disabled = true;

            try {
                const response = await fetch('/api/images/unwarp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_paths: selectedImagePaths
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    unwarpedData = data.unwarped;
                    successDiv.textContent = `Successfully unwarped ${Object.keys(unwarpedData).length} images (cached if already processed)`;
                    successDiv.classList.add('show');

                    // Display unwarped images
                    displayUnwarpedImages();

                    // Show unwarped panel
                    document.getElementById('unwarpedPanel').style.display = 'block';
                    document.getElementById('analysisPanel').style.display = 'block';
                    updateStep(3);

                    // Scroll to unwarped panel
                    document.getElementById('unwarpedPanel').scrollIntoView({ behavior: 'smooth' });
                } else {
                    errorDiv.textContent = 'Unwarp failed: ' + (data.detail || 'Unknown error');
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.classList.add('show');
            } finally {
                loading.classList.remove('show');
                unwarpBtn.disabled = false;
            }
        }

        function displayUnwarpedImages() {
            const grid = document.getElementById('unwarpedImagesGrid');
            grid.innerHTML = '';

            // Group by timestamp (original image)
            for (const [timestamp, directions] of Object.entries(unwarpedData)) {
                const group = document.createElement('div');
                group.className = 'unwarped-group';

                // Find the original image info
                const originalImg = availableImages.find(img => img.timestamp === timestamp);
                const groupTitle = originalImg ? `${originalImg.filename} - ${originalImg.date} ${originalImg.time}` : `Image ${timestamp}`;

                group.innerHTML = `<h3>${groupTitle}</h3><div class="unwarped-views" id="views-${timestamp}"></div>`;
                grid.appendChild(group);

                const viewsContainer = document.getElementById(`views-${timestamp}`);

                // Add each direction
                for (const [direction, path] of Object.entries(directions)) {
                    const card = document.createElement('div');
                    card.className = 'unwarped-card';
                    const id = `unwarped-${timestamp}-${direction}`;

                    card.innerHTML = `
                        <label style="cursor: pointer; display: block;">
                            <input type="checkbox"
                                   id="${id}"
                                   data-timestamp="${timestamp}"
                                   data-direction="${direction}"
                                   data-path="${path}"
                                   onchange="toggleUnwarpedSelection(this)">
                            <span class="direction-label">${DIRECTION_NAMES[direction]}</span>
                            <img src="/api/image/${path}" loading="lazy">
                        </label>
                    `;
                    viewsContainer.appendChild(card);
                }
            }

            // Make unwarped images clickable for fullscreen
            setTimeout(attachImageClickHandlers, 100);
        }

        function toggleUnwarpedSelection(checkbox) {
            const card = checkbox.closest('.unwarped-card');
            const timestamp = checkbox.dataset.timestamp;
            const direction = checkbox.dataset.direction;
            const path = checkbox.dataset.path;

            if (checkbox.checked) {
                selectedUnwarpedImages.push({ timestamp, direction, path });
                card.classList.add('selected');
            } else {
                selectedUnwarpedImages = selectedUnwarpedImages.filter(
                    img => !(img.timestamp === timestamp && img.direction === direction)
                );
                card.classList.remove('selected');
            }

            // Update count and enable/disable analyze button
            document.getElementById('selectedUnwarpedCount').textContent = selectedUnwarpedImages.length;
            document.getElementById('analyzeBtn').disabled = selectedUnwarpedImages.length === 0;
        }

        async function analyzeImages() {
            const prompt = document.getElementById('llmPrompt').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey) {
                alert('Please enter OpenAI API key');
                return;
            }

            if (selectedUnwarpedImages.length === 0) {
                alert('Please select at least one unwarped image to analyze');
                return;
            }

            const loading = document.getElementById('analyzeLoading');
            const errorDiv = document.getElementById('analyzeError');
            const resultsDiv = document.getElementById('analysisResults');
            const analyzeBtn = document.getElementById('analyzeBtn');

            loading.classList.add('show');
            errorDiv.classList.remove('show');
            analyzeBtn.disabled = true;
            resultsDiv.innerHTML = '';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: selectedUnwarpedImages,
                        prompt: prompt,
                        api_key: apiKey
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayAnalysisResults(data.result);
                    updateStep(4);

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success show';
                    successMsg.textContent = `Analysis complete! Results saved to ${data.result_file}`;
                    resultsDiv.insertBefore(successMsg, resultsDiv.firstChild);
                } else {
                    errorDiv.textContent = 'Analysis failed: ' + (data.detail || 'Unknown error');
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.classList.add('show');
            } finally {
                loading.classList.remove('show');
                analyzeBtn.disabled = false;
            }
        }

        function displayAnalysisResults(result) {
            const resultsDiv = document.getElementById('analysisResults');

            result.analyzed_images.forEach(imageResult => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';

                let html = `
                    <h3>${imageResult.timestamp} - ${imageResult.direction_name}</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Path: ${imageResult.filepath}</p>
                `;

                if (imageResult.error) {
                    html += `<div class="error show">${imageResult.error}</div>`;
                } else {
                    html += `
                        <div class="result-container">
                            <div>
                                <img src="/api/image/${imageResult.filepath}" class="result-image" alt="${imageResult.direction_name}">
                            </div>
                            <div class="result-content">${JSON.stringify(imageResult.llm_output, null, 2)}</div>
                        </div>
                    `;
                }

                resultItem.innerHTML = html;
                resultsDiv.appendChild(resultItem);
            });

            // Make result images clickable
            attachImageClickHandlers();
        }

        // Fullscreen image viewer functions
        function openFullscreen(imageSrc, imageInfo = '') {
            const overlay = document.getElementById('fullscreenOverlay');
            const image = document.getElementById('fullscreenImage');
            const info = document.getElementById('fullscreenInfo');

            image.src = imageSrc;
            info.textContent = imageInfo;
            info.style.display = imageInfo ? 'block' : 'none';
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeFullscreen(event) {
            if (event) {
                event.stopPropagation();
            }
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Attach click handlers to all images
        function attachImageClickHandlers() {
            // Handle image preview images (fisheye originals)
            document.querySelectorAll('.image-preview').forEach(img => {
                img.style.cursor = 'zoom-in';
                img.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const card = img.closest('.image-card');
                    const filename = card.querySelector('strong')?.textContent || '';
                    const info = card.querySelector('.image-info')?.textContent.trim() || '';
                    openFullscreen(img.src, `${filename} - ${info}`);
                };
            });

            // Handle unwarped images
            document.querySelectorAll('.unwarped-card img').forEach(img => {
                img.style.cursor = 'zoom-in';
                img.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const card = img.closest('.unwarped-card');
                    const direction = card.querySelector('.direction-label')?.textContent || '';
                    const group = card.closest('.unwarped-group');
                    const timestamp = group.querySelector('h3')?.textContent || '';
                    openFullscreen(img.src, `${direction} - ${timestamp}`);
                };
            });

            // Handle result images
            document.querySelectorAll('.result-image').forEach(img => {
                img.style.cursor = 'zoom-in';
                img.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const resultItem = img.closest('.result-item');
                    const title = resultItem.querySelector('h3')?.textContent || '';
                    openFullscreen(img.src, title);
                };
            });
        }

        // Close fullscreen on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
        });

        // Attach handlers when images are loaded initially
        window.addEventListener('load', attachImageClickHandlers);
    </script>
</body>
</html>
